# æµ‹è¯•æ™ºè°± GLM æµå¼å“åº”é—®é¢˜

## é—®é¢˜æè¿°

éœ€è¦éªŒè¯æ™ºè°± GLM ç³»åˆ—æ¨¡å‹æ˜¯å¦å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

> âŒ **æœ‰é—®é¢˜çš„åœºæ™¯**ï¼šåªæœ‰åœ¨è¯·æ±‚åŒ…å« `Role::Tool` æ¶ˆæ¯ï¼ˆå³å·¥å…·æ‰§è¡Œç»“æœï¼‰æ—¶ï¼ŒGLM ç³»åˆ—æ¨¡å‹çš„æµå¼ API æ‰ä¼šè¿”å›ç©ºå†…å®¹ã€‚

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: ç¬¬ä¸€è½®è¯·æ±‚ï¼ˆæ—  `Role::Tool` æ¶ˆæ¯ï¼‰
- ç”¨æˆ·æé—®è§¦å‘å·¥å…·è°ƒç”¨
- åº”è¯¥æ­£å¸¸è¿”å›æµå¼å“åº”
- é¢„æœŸï¼šå¤šä¸ªæµå¼å—ï¼ŒåŒ…å«å·¥å…·è°ƒç”¨ä¿¡æ¯

### åœºæ™¯ 2: ç¬¬äºŒè½®è¯·æ±‚ï¼ˆåŒ…å« `Role::Tool` æ¶ˆæ¯ï¼‰
- åŒ…å«å·¥å…·æ‰§è¡Œç»“æœ
- æ£€æŸ¥æµå¼å“åº”æ˜¯å¦è¿”å›ç©ºå†…å®¹
- é¢„æœŸï¼šå¦‚æœæœ‰é—®é¢˜ï¼Œä¼šè¿”å›ç©ºå†…å®¹æˆ–åªæœ‰ 1 ä¸ªå—

## è¿è¡Œæµ‹è¯•

### å‰ç½®æ¡ä»¶

1. è®¾ç½®æ™ºè°± API Keyï¼š
```bash
export ZHIPU_API_KEY="your-zhipu-api-key"
```

2. ç¡®ä¿å·²å¯ç”¨ streaming åŠŸèƒ½

### æ‰§è¡Œæµ‹è¯•

```bash
cargo run --example test_zhipu_tool_streaming_issue --features streaming
```

## æµ‹è¯•æ¨¡å‹

æµ‹è¯•å°†ä¾æ¬¡éªŒè¯ä»¥ä¸‹æ¨¡å‹ï¼š
- `glm-4-flash`
- `glm-4`
- `glm-4.5`

## é¢„æœŸè¾“å‡º

### æ­£å¸¸æƒ…å†µï¼ˆæ— é—®é¢˜ï¼‰

```
ğŸ“ æµ‹è¯•æ¨¡å‹: glm-4.5

âœ… åœºæ™¯ 1: ç¬¬ä¸€è½®è¯·æ±‚ï¼ˆæ—  Role::Tool æ¶ˆæ¯ï¼‰
   finish_reason: tool_calls
   æ”¶åˆ°æµå¼å—: 91 ä¸ª
   å†…å®¹é•¿åº¦: 0 å­—ç¬¦
   æœ‰å·¥å…·è°ƒç”¨: true

âš ï¸  åœºæ™¯ 2: ç¬¬äºŒè½®è¯·æ±‚ï¼ˆåŒ…å« Role::Tool æ¶ˆæ¯ï¼‰
   finish_reason: stop
   æ”¶åˆ°æµå¼å—: 85 ä¸ª
   å†…å®¹é•¿åº¦: 245 å­—ç¬¦
   å†…å®¹é¢„è§ˆ: æ ¹æ®æŸ¥è¯¢ç»“æœï¼Œä¸Šæµ·ç›®å‰çš„å¤©æ°”æƒ…å†µå¦‚ä¸‹ï¼š...

ğŸ“Š å¯¹æ¯”åˆ†æ:
   åœºæ™¯ 1ï¼ˆæ—  Toolï¼‰: 91 å—, 0 å­—ç¬¦
   åœºæ™¯ 2ï¼ˆæœ‰ Toolï¼‰: 85 å—, 245 å­—ç¬¦

   âœ… æ­£å¸¸: åŒ…å« Role::Tool æ—¶æµå¼å“åº”æ­£å¸¸
```

### å¼‚å¸¸æƒ…å†µï¼ˆæœ‰é—®é¢˜ï¼‰

```
ğŸ“ æµ‹è¯•æ¨¡å‹: glm-4.5

âœ… åœºæ™¯ 1: ç¬¬ä¸€è½®è¯·æ±‚ï¼ˆæ—  Role::Tool æ¶ˆæ¯ï¼‰
   finish_reason: tool_calls
   æ”¶åˆ°æµå¼å—: 91 ä¸ª
   å†…å®¹é•¿åº¦: 0 å­—ç¬¦
   æœ‰å·¥å…·è°ƒç”¨: true

âš ï¸  åœºæ™¯ 2: ç¬¬äºŒè½®è¯·æ±‚ï¼ˆåŒ…å« Role::Tool æ¶ˆæ¯ï¼‰
   finish_reason: stop
   æ”¶åˆ°æµå¼å—: 1 ä¸ª
   å†…å®¹é•¿åº¦: 0 å­—ç¬¦
   âš ï¸  å†…å®¹ä¸ºç©ºï¼

ğŸ“Š å¯¹æ¯”åˆ†æ:
   åœºæ™¯ 1ï¼ˆæ—  Toolï¼‰: 91 å—, 0 å­—ç¬¦
   åœºæ™¯ 2ï¼ˆæœ‰ Toolï¼‰: 1 å—, 0 å­—ç¬¦

   âŒ é—®é¢˜ç¡®è®¤: åŒ…å« Role::Tool æ—¶æµå¼è¿”å›ç©ºå†…å®¹ï¼
```

æˆ–è€…ï¼š

```
ğŸ“Š å¯¹æ¯”åˆ†æ:
   åœºæ™¯ 1ï¼ˆæ—  Toolï¼‰: 91 å—, 0 å­—ç¬¦
   åœºæ™¯ 2ï¼ˆæœ‰ Toolï¼‰: 1 å—, 245 å­—ç¬¦

   âš ï¸  å¯èƒ½çš„é—®é¢˜: æµå¼å—æ•°é‡æ˜¾è‘—å‡å°‘ï¼ˆå¯èƒ½è¢«å¼ºåˆ¶åˆ‡æ¢ä¸ºéæµå¼ï¼‰
```

## é—®é¢˜åˆ†æ

### å¦‚æœç¡®è®¤æœ‰é—®é¢˜

å¯èƒ½çš„åŸå› ï¼š
1. **æ™ºè°± API æœ¬èº«çš„é™åˆ¶**ï¼šAPI åœ¨å¤„ç†åŒ…å« `Role::Tool` çš„è¯·æ±‚æ—¶ä¸æ”¯æŒæµå¼å“åº”
2. **åè®®å®ç°é—®é¢˜**ï¼šè¯·æ±‚æ„å»ºæ—¶æŸäº›å­—æ®µå¯¼è‡´ API æ— æ³•æ­£ç¡®å¤„ç†æµå¼
3. **å“åº”è§£æé—®é¢˜**ï¼šæµå¼å“åº”çš„è§£æé€»è¾‘åœ¨å¤„ç†å·¥å…·è°ƒç”¨ç»“æœæ—¶æœ‰ bug

### è§£å†³æ–¹æ¡ˆ

å¦‚æœç¡®è®¤æ˜¯æ™ºè°± API çš„é™åˆ¶ï¼Œå¯èƒ½éœ€è¦ï¼š

1. **æ¢å¤ä¹‹å‰çš„ä¿®å¤é€»è¾‘**ï¼ˆåœ¨ `src/core/traits.rs` ä¸­ï¼‰ï¼š
```rust
#[cfg(feature = "streaming")]
async fn chat_stream(&self, request: &ChatRequest) -> Result<ChatStream, LlmConnectorError> {
    use crate::types::Role;
    use futures_util::stream;
    
    // æ™ºè°± API åœ¨åŒ…å« Role::Tool æ—¶ä¸æ”¯æŒæµå¼å“åº”
    let has_tool_messages = request.messages.iter().any(|m| m.role == Role::Tool);
    
    if has_tool_messages && self.protocol.name() == "zhipu" {
        // é™çº§ä¸ºéæµå¼è¯·æ±‚
        let response = self.chat(request).await?;
        let single_response = stream::once(async move { Ok(response.into()) });
        return Ok(Box::pin(single_response));
    }
    
    // æ­£å¸¸æµå¼å¤„ç†
    // ...
}
```

2. **æ·»åŠ é…ç½®é€‰é¡¹**ï¼šè®©ç”¨æˆ·é€‰æ‹©æ˜¯å¦å¯ç”¨è¿™ä¸ªä¿®å¤

3. **è”ç³»æ™ºè°±å®˜æ–¹**ï¼šç¡®è®¤æ˜¯å¦æ˜¯ API çš„å·²çŸ¥é™åˆ¶

## ç›¸å…³æ–‡ä»¶

- æµ‹è¯•ä»£ç ï¼š`examples/test_zhipu_tool_streaming_issue.rs`
- æ ¸å¿ƒå®ç°ï¼š`src/core/traits.rs`
- æ™ºè°±åè®®ï¼š`src/providers/zhipu.rs`

## æ³¨æ„äº‹é¡¹

1. æµ‹è¯•éœ€è¦çœŸå®çš„ API Key å’Œç½‘ç»œè¿æ¥
2. æµ‹è¯•ä¼šæ¶ˆè€— API é…é¢ï¼ˆæ¯ä¸ªæ¨¡å‹ 2 æ¬¡è¯·æ±‚ï¼‰
3. å¦‚æœç¬¬ä¸€è½®æœªè§¦å‘å·¥å…·è°ƒç”¨ï¼Œä¼šè·³è¿‡ç¬¬äºŒè½®æµ‹è¯•

